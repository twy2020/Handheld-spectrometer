# AS7341光谱仪设备使用说明书

## 1. 产品概述

AS7341光谱仪设备是一款基于ESP32的多功能光谱测量仪器，集成了AS7341光谱传感器、OLED显示屏、UV LED、蜂鸣器等组件，支持本地操作和远程数据流传输两种工作模式。

### 主要特性

- **光谱测量**：8通道光谱数据采集（F1-F8）
- **双工作模式**：本地显示模式 + 数据流传输模式
- **无线通信**：WiFi连接，支持TCP指令控制和UDP数据流传输
- **本地控制**：OLED菜单 + 三按键操作
- **可编程光源**：AS7341内置LED和外部UV LED，亮度可调
- **状态指示**：蜂鸣器声音反馈

## 2. 硬件规格

### 2.1 硬件接口

- **OLED显示屏**：128×64分辨率，显示菜单和光谱数据
- **控制按键**：
  - UP键：向上选择/增加数值
  - SEL键：确认/进入菜单
  - DOWN键：向下选择/减少数值
- **传感器**：AS7341 11通道光谱传感器
- **光源**：
  - AS7341内置LED（可调亮度）
  - 外部UV LED（可调亮度）
- **音频**：压电蜂鸣器（可调音量）

### 2.2 通信接口

- **WiFi**：2.4GHz IEEE 802.11 b/g/n
- **指令端口**：TCP 6688（JSON格式指令）
- **数据流端口**：UDP 6699（光谱数据流）
- **目标服务器端口**：TCP 6677（状态通知）
- **USB串口**：波特率 115200 （开发调试）

## 3. 快速开始

### 3.1 设备启动

1. 连接电源（Micro-USB）
2. 设备自动启动，显示初始化界面
3. 进入默认的光谱显示模式

### 3.2 基本操作

- **短按SEL键**：进入主菜单
- **UP/DOWN键**：在菜单中导航
- **长按SEL键**：返回上一级菜单

## 4. 菜单系统详解

### 4.1 光谱显示模式（默认）

设备启动后自动进入此模式，显示三页信息：

**页面1 - 光谱数据**

- 实时显示8个光谱通道的数值
- F1-F4显示在左侧，F5-F8显示在右侧

**页面2 - 系统状态**

- AS7341传感器状态
- AS7341 LED状态
- UV LED状态  
- 蜂鸣器状态

**页面3 - WiFi状态**

- WiFi使能状态
- 连接状态（已连接/连接中/未连接）
- SSID信息
- IP地址信息
- 重连状态

### 4.2 主菜单选项

#### 1. AS7341控制

- **LED亮度**：1-20级可调，UP增加，DOWN减少
- **LED开关**：UP开启，DOWN关闭

#### 2. UV LED控制

- **UV亮度**：1-20级可调
- **UV开关**：UP开启，DOWN关闭

#### 3. 蜂鸣器控制

- **音量调节**：1-10级可调
- **蜂鸣器开关**：UP开启，DOWN关闭

#### 4. WiFi设置

**WiFi SSID**：设置无线网络名称
**WiFi密码**：设置无线网络密码
**固定IP**：设置设备静态IP（可选，留空使用DHCP）
**目标IP**：设置数据接收服务器IP地址
**WiFi开关**：启用/禁用WiFi功能
**手动重连**：立即重新连接WiFi

#### 5. 退出

返回光谱显示模式

## 5. WiFi设置详细说明

### 5.1 编辑模式操作

进入任意编辑项目（SSID、密码、IP地址）：

**字符选择模式**：

- UP/DOWN：切换字符
- SEL：确认选择当前字符
- 长按SEL：保存并退出

**编辑模式**（长按UP进入）：

- UP：光标右移
- DOWN：光标左移  
- SEL：删除光标前字符
- 长按DOWN：退出编辑模式

### 5.2 连接状态指示

- **连接中**：显示"Connecting"
- **已连接**：显示IP地址和信号强度
- **连接失败**：显示重试次数和最大重连次数
- **超过重试限制**：显示"Max retries reached"

## 6. 数据流模式

### 6.1 进入数据流模式

**前提条件**：

- WiFi已连接
- 目标IP已正确设置
- 传感器初始化成功

**进入方式**：
通过TCP指令发送：`{"dataStream": true}`

### 6.2 数据流模式显示

在数据流模式下，OLED显示：

- 数据包计数
- 实时发送频率（FPS）
- 发送模式（持续/指定次数）
- 当前计数/目标计数（指定次数模式）
- 发送状态（运行中/暂停）
- 发送间隔

### 6.3 数据流控制指令

**发送模式设置**：

```json
{"streamMode": "continuous"}  // 持续发送模式
{"streamMode": "fixed", "streamCount": 1000}  // 指定次数模式
```

**单独设置发送次数**：

```json
{"streamCount": 500}
```

**退出数据流模式**：

```json
{"dataStream": false}
```

## 7. 远程控制指令

### 7.1 设备控制指令

**AS7341 LED控制**：

```json
{"as7341Led": true}  // 开启
{"as7341Led": false} // 关闭
{"as7341Brightness": 15}  // 设置亮度(1-20)
```

**UV LED控制**：

```json
{"uvLed": true}      // 开启
{"uvLed": false}     // 关闭  
{"uvBrightness": 10} // 设置亮度(1-20)
```

**蜂鸣器控制**：

```json
{"buzzer": true}     // 开启
{"buzzer": false}    // 关闭
```

**设备状态查询**：

```json
{"getDeviceStatus": true}
```

**设备重启**：

```json
{"reboot": true}
```

### 7.2 指令响应

设备对每个指令都会返回JSON格式响应：

```json
{"response": "OK"}
{"response": "ERROR: 错误信息"}
```

## 8. 数据格式说明

### 8.1 光谱数据格式（UDP）

```json
{
  "t": 123456789,      // 时间戳(ms)
  "d": [123,456,789,...], // 8通道光谱数据
  "c": 1000,           // 数据包计数
  "sc": 50             // 当前发送计数（指定次数模式）
}
```

### 8.2 设备状态格式

```json
{
  "type": "deviceStatus",
  "device": "AS7341_Sensor_Device",
  "timestamp": 123456789,
  "status": {
    "as7341_led": true,
    "as7341_bright": 10,
    "uv_led": false, 
    "uv_bright": 15,
    "buzzer": true,
    "sensor": true,
    "stream_mode": "continuous",
    "stream_paused": false,
    "packet_count": 1000,
    "interval": 100,
    "current_count": 500,
    "target_count": 1000
  }
}
```

### 8.3 连接状态通知

```json
{
  "type": "connection", 
  "status": "connected",
  "device": "AS7341_Sensor_Device",
  "timestamp": 123456789,
  "ip": "192.168.1.100",
  "rssi": -65
}
```

### 8.4 数据流完成通知

```json
{
  "type": "streamComplete",
  "device": "AS7341_Sensor_Device", 
  "timestamp": 123456789,
  "total_packets": 5000,
  "stream_mode": "fixed",
  "target_count": 5000,
  "actual_count": 5000,
  "status": "completed"
}
```

## 9. 故障排除

### 9.1 常见问题

**WiFi连接失败**：

- 检查SSID和密码是否正确
- 确认路由器2.4GHz频段可用
- 检查信号强度
- 尝试手动重连功能

**传感器读数异常**：

- 检查传感器连接
- 确认环境光照条件合适
- 重启设备

**数据流发送失败**：

- 确认目标IP和端口正确
- 检查网络连通性
- 确认接收端服务正常运行

**设备无响应**：

- 检查电源供电
- 尝试硬件重启
- 检查USB连接线

### 9.2 状态指示灯

- **启动音**：一声蜂鸣表示启动成功
- **操作音**：短蜂鸣表示按键操作
- **错误音**：两声短蜂鸣表示操作错误
- **连接音**：启动时WiFi连接成功提示

## 10. 技术参数

- **工作电压**：5V DC（USB供电）
- **工作电流**：待机<100mA，工作峰值<300mA
- **光谱范围**：400-700nm（8个通道）
- **ADC分辨率**：16位
- **数据输出率**：最高100Hz（可配置）
- **工作温度**：0-40℃
- **存储温度**：-20-60℃
- **WiFi标准**：IEEE 802.11 b/g/n

## 11. 维护与保养

- 保持传感器窗口清洁
- 避免强光直射传感器
- 定期检查固件更新
- 避免潮湿和高温环境
- 使用原装电源适配器

---

**技术支持**：如遇问题，请记录设备显示的异常信息并联系技术支持人员（Teng email:tenwonyun@gmail.com）。

**版本信息**：本说明书对应固件版本 v2.0.0
